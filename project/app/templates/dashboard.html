<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Shape Analytics Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e5f0ff;
      margin: 0;
      padding: 0;
    }
    .page {
      max-width: 1100px;
      margin: 32px auto;
      padding: 0 16px 40px;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 1.7rem;
      color: #102a43;
    }
    .subtitle {
      color: #52637a;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: 2fr 3fr;
      gap: 16px;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 1.1rem;
      color: #111827;
    }
    .card p {
      margin: 4px 0;
      font-size: 0.85rem;
      color: #6b7280;
    }
    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .kpi {
      background: #eff6ff;
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 0.85rem;
      min-width: 110px;
    }
    .kpi strong {
      display: block;
      font-size: 0.9rem;
      color: #111827;
    }
    label {
      font-size: 0.8rem;
      color: #4b5563;
      display: block;
      margin-bottom: 4px;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    button {
      margin-top: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 6px;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e5e7eb;
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .list {
      margin-top: 8px;
      font-size: 0.85rem;
    }
    .list h3 {
      font-size: 0.9rem;
      margin: 4px 0;
      color: #111827;
    }
    .list ul {
      margin: 4px 0 8px;
      padding-left: 18px;
    }
    .list li {
      margin-bottom: 3px;
    }
    .footer {
      margin-top: 16px;
      font-size: 0.75rem;
      color: #94a3b8;
    }
    code {
      font-size: 0.8rem;
      background: #e5e7eb;
      border-radius: 4px;
      padding: 1px 4px;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Shape Analytics Dashboard</h1>
    <div class="subtitle">
      Cross-industry cognitive & behavioral insights. Use for schools, hiring, training, or high-stakes operations.
    </div>

    <div class="grid">
      <!-- LEFT: Global metrics -->
      <div class="card">
        <h2>Global Overview</h2>
        <p>Aggregated metrics across all participants and tasks.</p>
        <div id="global-kpis" class="kpi-row">
          <div class="kpi"><strong>Loading…</strong></div>
        </div>
        <div id="global-status" class="status"></div>
      </div>

      <!-- RIGHT: Participant report -->
      <div class="card">
        <h2>Participant Report</h2>
        <p>Look up a participant by ID to view their strengths and gaps.</p>

        <label for="participant-id">Participant ID</label>
        <input id="participant-id" type="text" placeholder="e.g. hp_e933f45a">
        <button id="load-report-btn">Load report</button>

        <div id="report-status" class="status"></div>

        <div id="report-summary" class="kpi-row" style="margin-top: 10px;"></div>

        <div id="report-skills" class="list"></div>
      </div>
    </div>

    <div class="footer">
      Tip: When running a live demo, start a session in <code>/demo</code>, copy the participant ID from the console or API response,
      then paste it here to show their live report.
    </div>
  </div>

  <script>
    async function loadGlobalMetrics() {
      const statusEl = document.getElementById("global-status");
      const kpiEl = document.getElementById("global-kpis");
      statusEl.textContent = "Loading global metrics…";

      try {
        const resp = await fetch("/metrics/global");
        const data = await resp.json();

        if (!data.has_data) {
          statusEl.textContent = "No data yet. Run a few sessions first.";
          kpiEl.innerHTML = '<div class="kpi"><strong>0</strong>Total attempts</div>';
          return;
        }

        statusEl.textContent = "";

        const accuracy = (data.accuracy != null)
          ? (data.accuracy * 100).toFixed(1) + "%"
          : "—";

        kpiEl.innerHTML = `
          <div class="kpi">
            <strong>${data.total_attempts ?? "—"}</strong>
            Total attempts
          </div>
          <div class="kpi">
            <strong>${accuracy}</strong>
            Overall accuracy
          </div>
          <div class="kpi">
            <strong>${data.participants_count ?? "—"}</strong>
            Participants
          </div>
          <div class="kpi">
            <strong>${data.average_response_time_s != null ? data.average_response_time_s.toFixed(1) + "s" : "—"}</strong>
            Avg response time
          </div>
        `;
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error loading global metrics.";
        kpiEl.innerHTML = '<div class="kpi"><strong>—</strong>Error</div>';
      }
    }

    async function loadParticipantReport() {
      const idInput = document.getElementById("participant-id");
      const pid = (idInput.value || "").trim();
      const statusEl = document.getElementById("report-status");
      const summaryEl = document.getElementById("report-summary");
      const skillsEl = document.getElementById("report-skills");
      const btn = document.getElementById("load-report-btn");

      if (!pid) {
        statusEl.textContent = "Enter a participant ID first.";
        return;
      }

      statusEl.textContent = "Loading report…";
      summaryEl.innerHTML = "";
      skillsEl.innerHTML = "";
      btn.disabled = true;

      try {
        const resp = await fetch("/metrics/report/" + encodeURIComponent(pid));
        const data = await resp.json();

        if (!data.ok) {
          statusEl.textContent = "No data found for this participant.";
          return;
        }

        statusEl.textContent = `Report loaded for ${data.participant_id}.`;

        const s = data.summary || {};

        const accuracy = (s.accuracy != null)
          ? (s.accuracy * 100).toFixed(1) + "%"
          : "—";

        summaryEl.innerHTML = `
          <div class="kpi">
            <strong>${s.total_attempts ?? "—"}</strong>
            Attempts
          </div>
          <div class="kpi">
            <strong>${accuracy}</strong>
            Accuracy
          </div>
          <div class="kpi">
            <strong>${s.sessions_count ?? "—"}</strong>
            Sessions
          </div>
        `;

        const skills = data.skills || {};
        const strengths = skills.strengths || [];
        const gaps = skills.gaps || [];

        let html = "";

        html += "<h3>Strengths</h3>";
        if (strengths.length === 0) {
          html += "<p><span class=\"pill\">No strong signals yet</span></p>";
        } else {
          html += "<ul>";
          strengths.forEach(item => {
            html += `<li>${item.category} — ${(item.accuracy * 100).toFixed(1)}% accuracy (${item.attempts} attempts)</li>`;
          });
          html += "</ul>";
        }

        html += "<h3>Gaps / Focus Areas</h3>";
        if (gaps.length === 0) {
          html += "<p><span class=\"pill\">No clear gaps yet</span></p>";
        } else {
          html += "<ul>";
          gaps.forEach(item => {
            html += `<li>${item.category} — ${(item.accuracy * 100).toFixed(1)}% accuracy (${item.attempts} attempts)</li>`;
          });
          html += "</ul>";
        }

        skillsEl.innerHTML = html;

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error loading report.";
      } finally {
        btn.disabled = false;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadGlobalMetrics();

      document
        .getElementById("load-report-btn")
        .addEventListener("click", loadParticipantReport);

      document
        .getElementById("participant-id")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            loadParticipantReport();
          }
        });
    });
  </script>
</body>
</html>

